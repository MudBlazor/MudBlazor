@namespace MudBlazor
@inherits MudComponentBase
@typeparam T

<TemplateColumn T="T" Tag="@("hierarchy-column")" Sortable="false" Resizable="false" ShowColumnOptions="false" HeaderStyle="width:0%"
    Hideable="Hideable" Hidden="Hidden" HiddenChanged="HiddenChanged"
    Filterable="false" Editable="false" DragAndDropEnabled="@DragAndDropEnabled">
    <CellTemplate>
        @if (!_finishedInitialExpanded && InitiallyExpandedFunc.Invoke(context.Item))
        {
            context.OpenHierarchies.Add(context.Item);
        }
        <MudIconButton 
            Class="ma-n3 pa-1"
            Icon="@(context.OpenHierarchies.Contains(context.Item) ?  OpenIcon : ClosedIcon)" 
            OnClick="context.Actions.ToggleHierarchyVisibilityForItemAsync"
            Size="@IconSize"
            Disabled="ButtonDisabledFunc.Invoke(context.Item)"/>
    </CellTemplate>
</TemplateColumn>

@code {
    [Parameter] public string ClosedIcon { get; set; } = Icons.Material.Filled.ChevronRight;
    [Parameter] public string OpenIcon { get; set; } = Icons.Material.Filled.ExpandMore;
    [Parameter] public Size IconSize { get; set; } = Size.Medium;
    [Parameter] public Func<T, bool> ButtonDisabledFunc { get; set; } = x => false;
    [Parameter] public Func<T, bool> InitiallyExpandedFunc { get; set; } = x => false;

    private bool _finishedInitialExpanded = false;

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);
        if(firstRender)
        {
            _finishedInitialExpanded = true;
        }
    }
}
